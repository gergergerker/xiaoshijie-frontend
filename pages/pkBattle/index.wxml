<!-- é˜µè¥PKå¯¹æˆ˜é¡µé¢ -->
<view class="pk-container">
  <!-- é¡¶éƒ¨é˜µè¥å±•ç¤ºåŒºåŸŸ -->
  <view class="factions-header">
    <view class="faction-status tower">
      <image class="faction-avatar" src="../lanTing/pics/æ¥¼å°çƒŸé›¨ä¸­.jpg" mode="aspectFill"></image>
      <view class="faction-info">
        <view class="faction-name">æ¥¼å°çƒŸé›¨ä¸­</view>
        <view class="faction-stats">
          <view class="faction-count">{{towerCount}}äºº</view>
          <view class="faction-score">{{towerScore}}åˆ†</view>
        </view>
      </view>
    </view>
    
    <view class="vs-badge">VS</view>
    
    <view class="faction-status rain">
      <image class="faction-avatar" src="../lanTing/pics/å¥½é›¨çŸ¥æ—¶èŠ‚.jpg" mode="aspectFill"></image>
      <view class="faction-info">
        <view class="faction-name">å¥½é›¨çŸ¥æ—¶èŠ‚</view>
        <view class="faction-stats">
          <view class="faction-count">{{rainCount}}äºº</view>
          <view class="faction-score">{{rainScore}}åˆ†</view>
        </view>
      </view>
    </view>
  </view>
  
  <!-- çŠ¶æ€æŒ‡ç¤ºå™¨ -->
  <view class="status-indicator">
    <view class="status-text">{{statusText}}</view>
    <view class="timer" wx:if="{{showTimer}}">{{timeRemaining}}s</view>
  </view>
  
  <!-- é¢˜ç›®åŒºåŸŸ -->
  <view class="question-area" wx:if="{{currentState === 'question'}}">
    <view class="question-header">
      <view class="question-type">
        {{currentQuestionType === 'single' ? 'å•é€‰é¢˜' : 
          currentQuestionType === 'multiple' ? 'å¤šé€‰é¢˜' : 'å¡«ç©ºé¢˜'}}
      </view>
      <view class="question-number">ç¬¬ {{currentQuestionIndex + 1}}/{{totalQuestions}} é¢˜</view>
    </view>
    
    <view class="question-text">{{currentQuestion.text}}</view>
    
    <!-- å•é€‰é¢˜é€‰é¡¹ -->
    <view class="options-container" wx:if="{{currentQuestionType === 'single'}}">
      <view class="option-item {{selectedOptions.includes(index) ? 'selected' : ''}}" 
            wx:for="{{currentQuestion.options}}" 
            wx:key="index"
            bindtap="selectOption"
            data-option-index="{{index}}">
        <text class="option-letter">{{optionLetters[index]}}</text>
        <text class="option-text">{{item}}</text>
      </view>
    </view>
    
    <!-- å¤šé€‰é¢˜é€‰é¡¹ -->
    <view class="options-container" wx:if="{{currentQuestionType === 'multiple'}}">
      <view class="option-item {{selectedOptions.includes(index) ? 'selected' : ''}}" 
            wx:for="{{currentQuestion.options}}" 
            wx:key="index"
            bindtap="toggleOption"
            data-option-index="{{index}}">
        <text class="option-letter">{{optionLetters[index]}}</text>
        <text class="option-text">{{item}}</text>
        <view class="checkbox {{selectedOptions.includes(index) ? 'checked' : ''}}"></view>
      </view>
    </view>
    
    <!-- å¡«ç©ºé¢˜è¾“å…¥æ¡† -->
    <view class="fill-container" wx:if="{{currentQuestionType === 'fill'}}">
      <input class="fill-input" placeholder="è¯·è¾“å…¥ç­”æ¡ˆ" value="{{fillAnswer}}" bindinput="updateFillAnswer" />
    </view>
    
    <!-- æäº¤æŒ‰é’® -->
    <button class="submit-answer" bindtap="submitAnswer" disabled="{{!canSubmit}}">
      æäº¤ç­”æ¡ˆ
    </button>
  </view>
  
  <!-- ç­‰å¾…åŒºåŸŸ -->
  <view class="waiting-area" wx:if="{{currentState === 'waiting'}}">
    <view class="waiting-text">
      <view>ç­‰å¾…ä¸»æŒäººå‘å¸ƒä¸‹ä¸€é¢˜...</view>
      <view class="waiting-subtext">å·²ç­”{{answeredQuestions}}é¢˜ï¼Œæ­£ç¡®{{correctAnswers}}é¢˜</view>
    </view>
    <view class="loading-dots">
      <view class="dot"></view>
      <view class="dot"></view>
      <view class="dot"></view>
    </view>
  </view>
  
  <!-- ç»“æœåŒºåŸŸ -->
  <view class="result-area" wx:if="{{currentState === 'result'}}">
    <view class="result-header">
      <view class="result-title">PKç»“æœå…¬å¸ƒ</view>
    </view>
    
    <view class="winner-announcement">
      <view class="winner-title">è·èƒœé˜µè¥</view>
      <view class="winner-faction">{{winnerFaction === 'tower' ? 'æ¥¼å°çƒŸé›¨ä¸­' : 'å¥½é›¨çŸ¥æ—¶èŠ‚'}}</view>
      <view class="winner-reward">å¥–åŠ±: æ¯äºº{{userFaction === winnerFaction ? 2 : 1}}é¢—ğŸŒ³</view>
    </view>
    
    <!-- ä¸ªäººæˆç»©åŒºåŸŸ -->
    <view class="personal-result">
      <view class="personal-title">æˆ‘çš„æˆç»©</view>
      <view class="personal-content">
        <view class="personal-item">
          <view class="personal-label">æˆ‘çš„æ’å</view>
          <view class="personal-value">{{userRanking > 0 ? userRanking : 'æœªä¸Šæ¦œ'}}</view>
        </view>
        <view class="personal-item">
          <view class="personal-label">æ­£ç¡®ç‡</view>
          <view class="personal-value">{{totalQuestions > 0 ? Math.round(userScore/totalQuestions*100) : 0}}%</view>
        </view>
        <view class="personal-item">
          <view class="personal-label">è·å¾—å¥–åŠ±</view>
          <view class="personal-value">{{userReward}}é¢—ğŸŒ³</view>
        </view>
      </view>
    </view>
    
    <view class="top-performers">
      <view class="performers-title">ä»Šæ—¥æ’è¡Œæ¦œ</view>
      <view class="performer-list">
        <view class="performer-item {{item.isCurrentUser ? 'current-user' : ''}}" wx:for="{{topPerformers}}" wx:key="index" wx:if="{{index < 10}}">
          <view class="performer-rank">
            <text wx:if="{{index === 0}}">ğŸ¥‡ 1</text>
            <text wx:elif="{{index === 1}}">ğŸ¥ˆ 2</text>
            <text wx:elif="{{index === 2}}">ğŸ¥‰ 3</text>
            <text wx:else>{{index + 1}}</text>
          </view>
          <view class="performer-info">
            <view class="performer-name">{{item.name}}{{item.isCurrentUser ? ' (æˆ‘)' : ''}}</view>
            <view class="performer-faction">{{item.faction === 'tower' ? 'æ¥¼å°çƒŸé›¨ä¸­' : 'å¥½é›¨çŸ¥æ—¶èŠ‚'}}</view>
          </view>
          <view class="performer-score">{{item.score}}åˆ†</view>
        </view>
      </view>
    </view>
    
    <view class="pk-statistics">
      <view class="statistics-title">PKç»Ÿè®¡</view>
      <view class="statistics-grid">
        <view class="stat-item">
          <view class="stat-label">æ€»é¢˜æ•°</view>
          <view class="stat-value">{{totalQuestions}}</view>
        </view>
        <view class="stat-item">
          <view class="stat-label">å‚ä¸äººæ•°</view>
          <view class="stat-value">{{towerCount + rainCount}}</view>
        </view>
        <view class="stat-item">
          <view class="stat-label">æ€»ç­”é¢˜æ•°</view>
          <view class="stat-value">{{totalAnswers}}</view>
        </view>
        <view class="stat-item">
          <view class="stat-label">å¹³å‡æ­£ç¡®ç‡</view>
          <view class="stat-value">{{avgCorrectRate}}%</view>
        </view>
      </view>
    </view>
    
    <!-- å‚è€ƒç­”æ¡ˆåŒºåŸŸ -->
    <view class="answers-reference">
      <view class="reference-header" bindtap="toggleAnswersDisplay">
        <view class="reference-title">å‚è€ƒç­”æ¡ˆ</view>
        <view class="toggle-icon">{{showAnswers ? 'æ”¶èµ·' : 'å±•å¼€'}}</view>
      </view>
      
      <view class="answers-content" wx:if="{{showAnswers}}">
        <!-- å•é€‰é¢˜ç­”æ¡ˆ -->
        <view class="answer-section">
          <view class="answer-category">å•é€‰é¢˜</view>
          <view class="answer-list">
            <view class="answer-item" wx:for="{{questions.single}}" wx:key="id">
              <view class="answer-question">{{index + 1}}. {{item.text}}</view>
              <view class="answer-content">
                <text class="answer-label">æ­£ç¡®ç­”æ¡ˆ: </text>
                <text class="answer-value">{{optionLetters[item.correctAnswer]}}. {{item.options[item.correctAnswer]}}</text>
              </view>
            </view>
          </view>
        </view>
        
        <!-- å¤šé€‰é¢˜ç­”æ¡ˆ -->
        <view class="answer-section">
          <view class="answer-category">å¤šé€‰é¢˜</view>
          <view class="answer-list">
            <view class="answer-item" wx:for="{{questions.multiple}}" wx:key="id">
              <view class="answer-question">{{index + 6}}. {{item.text}}</view>
              <view class="answer-content">
                <text class="answer-label">æ­£ç¡®ç­”æ¡ˆ: </text>
                <text class="answer-value">
                  <block wx:for="{{item.correctAnswers}}" wx:for-item="answerIndex" wx:key="*this">
                    {{optionLetters[answerIndex]}}
                    <text wx:if="{{index < item.correctAnswers.length - 1}}">, </text>
                  </block>
                </text>
              </view>
            </view>
          </view>
        </view>
        
        <!-- å¡«ç©ºé¢˜ç­”æ¡ˆ -->
        <view class="answer-section">
          <view class="answer-category">å¡«ç©ºé¢˜</view>
          <view class="answer-list">
            <view class="answer-item" wx:for="{{questions.fill}}" wx:key="id">
              <view class="answer-question">{{index + 11}}. {{item.text}}</view>
              <view class="answer-content">
                <text class="answer-label">æ­£ç¡®ç­”æ¡ˆ: </text>
                <text class="answer-value">{{item.correctAnswer}}</text>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>
    
    <button class="return-home" bindtap="returnToHome">è¿”å›é¦–é¡µ</button>
  </view>
</view> 